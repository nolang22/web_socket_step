<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
    <style>
        /* 1. 기본 초기화 */
        * {
            box-sizing: border-box
        }

        body {
            margin: 20px;
            background-color: #f5f5f5;
            font-family: sans-serif;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 500px;
            height: 600px;
            background-color: white;
            border-radius: 10px;

            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);

            display: flex;
            flex-direction: column;

            overflow: hidden;
        }

        /*    헤더    */
        .header {
            background-color: #3b5998;
            color: white;
            text-align: center;
            padding: 15px;
        }

        /*   채팅 목록 영역  */
        .chat-box {
            flex: 1;
            background-color: white;
            overflow-y: auto;
            padding: 20px;
        }

        /* 개별 메세지 디자인 */
        .msg-box {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .name {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;

        }

        .msg {
            background-color: #e9e9eb;
            padding: 10px 15px;
            border-radius: 15px;
            border-top-left-radius: 0;
            font-size: 14px;
            max-width: 80%;

            white-space: pre-wrap;
        }

        .input-area {
            background-color: #f0f2f5;
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .input-sender {
            width: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .input-msg {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .btn-send {
            background-color: #3b5998;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <h3>불타는 채팅방(SSE)</h3>
        <p>실시간 채팅 - 푸쉬서버</p>
    </div>

    <div class="chat-box" id="chatBox">

        <!--  반복 시작           -->
        {{#chatList}}
            <div class="msg-wrap">
                <div class="msg-box">
                    <span class="name">{{sender}}</span>
                    <span class="msg">{{message}}</span>
                </div>
            </div>
        {{/chatList}}
    </div>

    <!--    -->
    <form id="chatForm" class="input-area">
        <input type="text" id="sender" name="sender" value="익명" class="input-sender" required>
        <input type="text" id="message" name="message" placeholder="내용을 입력..." class="input-msg" autofocus>
        <button type="submit" class="btn-send">전송</button>
    </form>

</div>
<script>

    // 3초 마다 서버에 새로운 데이터가 있니 요청 하는 방식
    // 1. 화면에 스크롤 바닥 고정
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");

    chatBox.scrollTop = chatBox.scrollHeight;


    // http://192.168.4.101:8080/
    // 2. SSE 연결 설정
    // - EventSource jS API (SSE 처리하기 위해 제공)
    // 하나의 논리적인 연결지속되는 선을 요청 한다.
    //  /sse/connect 서버 측과 클라이언 간에 약속
    const eventSource = new EventSource("/sse/connect");
    eventSource.onopen = () => console.log("SSE 연결 성공");
    eventSource.onerror = () => console.log("SSE 연결 에러 (자동연결 재 시도)");
    // 페이지 종료 시 연결 종료
    window.addEventListener("beforeunload", () => {
        eventSource.close();
    });

    eventSource.addEventListener('newMessage', (event) => {
        // 데이터 형식 : "Sender: Message"
        const rawData = event.data;
        console.log("rawData : " + rawData);
        // 홍길동:안녕하세요
        // 0 1 2 3 4
        const separatorIndex = rawData.indexOf(":")
        let sender = "익명";
        let message = rawData;

        // 3
        if(separatorIndex !== -1) {
            sender = rawData.substring(0, separatorIndex);
            message = rawData.substring(separatorIndex + 1)
        }

        // DOM 요소 생성
        const msgWrap = document.createElement("div");
        msgWrap.className = "msg-wrap";

        const msgBox = document.createElement("div");
        msgWrap.className = "msg-box";

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = sender; // 넘겨 받은 보낸이 값 주입

        const msgSpan = document.createElement("span");
        msgSpan.className = "msg";
        msgSpan.textContent = message; // 넘겨 받은 메세지 값 주입

        // 조립
        msgBox.appendChild(nameSpan);
        msgBox.appendChild(msgSpan);

        msgWrap.appendChild(msgBox);

        // 채팅창에 요소 추가
        chatBox.appendChild(msgWrap);

        // 스크롤을 바닥으로 이동
        chatBox.scrollTop = chatBox.scrollHeight;

    });


    // form 기본 이벤트 제거
    chatForm.addEventListener("submit", function (e) {
        e.preventDefault(); // 기본 submit 이벤트 방지 (새로고침 방지)

        const senderInput = document.getElementById("sender");
        const messageInput = document.getElementById("message");

        const sender = senderInput.value;
        const message = messageInput.value;

        if(!message.trim()) {
            alert("메세지는 반드시 입력");
            return;
        }

        // fetch 비동기 통신 처리
        fetch("/sse/send", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            // 폼 데이터 형식으로 변환 key=value --> sender="홍길동"&messag="...."
            body: new URLSearchParams({
                sender: sender,
                message: message
            })
        })
                .then(response => {
                    // 전송 성공 시 입력창 비우기
                    if(response.ok) {
                        messageInput.value = "";
                        messageInput.focus();
                    } else {
                        console.log("전송 실패")
                    }
                })
                .catch(error => console.log("에러 발생 : ", error));

    });

</script>

</body>
</html>